<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NIBI â€“ NFC Voice Oracle</title>
</head>
<body style="margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;">

  <div id="nibi-nfc" style="max-width:920px;margin:40px auto;padding:22px;">
    <div style="max-width:720px;margin:0 auto;padding:22px;border-radius:26px;
      background:radial-gradient(circle at top,#121a44 0,#070a18 55%,#040513 100%);
      border:1px solid rgba(255,217,119,.28);
      box-shadow:0 0 40px rgba(142,164,255,.16);
      color:#e9ecff;">

      <h1 style="margin:0 0 8px;text-align:center;color:#ffd977;letter-spacing:.4px;">
        ğŸ”® NIBI â€“ NFC Voice Oracle
      </h1>
      <p style="margin:0 0 18px;text-align:center;color:#c9d0ff;line-height:1.4;">
        Premi â€œAttiva NFCâ€, poi tocca il tag. Su PC lâ€™NFC non esiste: usa â€œTESTA (PC)â€ per provare la chiamata a Nibi.
      </p>

      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0 10px;">
        <button id="btnStartNFC" style="cursor:pointer;border:0;border-radius:999px;padding:12px 16px;font-weight:800;
          background:linear-gradient(90deg,#ffd977,#ffe9b5);color:#080a16;box-shadow:0 0 20px rgba(255,217,119,.33);">
          ğŸ“¶ Attiva NFC
        </button>

        <button id="btnTestPC" style="cursor:pointer;border:1px solid rgba(142,164,255,.45);border-radius:999px;padding:12px 16px;font-weight:800;
          background:radial-gradient(circle at top,#1a2150,#0b0e1a);color:#e9ecff;box-shadow:0 0 18px rgba(142,164,255,.16);">
          ğŸ§ª TESTA (PC)
        </button>

        <button id="btnSpeak" disabled style="cursor:pointer;border:1px solid rgba(142,164,255,.45);border-radius:999px;padding:12px 16px;font-weight:800;
          background:transparent;color:#e9ecff;opacity:.55;">
          ğŸ”Š Parla
        </button>

        <button id="btnStop" disabled style="cursor:pointer;border:1px solid rgba(255,217,119,.25);border-radius:999px;padding:12px 16px;font-weight:800;
          background:transparent;color:#ffd977;opacity:.55;">
          â›” Stop
        </button>
      </div>

      <div id="status" style="margin:14px 0 14px;padding:12px 14px;border-radius:14px;
        background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);color:#c9d0ff;">
        Stato: pronto.
      </div>

      <div style="padding:16px;border-radius:18px;background:rgba(5,9,28,.92);border:1px solid rgba(142,164,255,.25);">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;">
          <div><b style="color:#ffe9b5;">Elemento:</b> <span id="el">â€”</span></div>
          <div><b style="color:#ffe9b5;">Runa:</b> <span id="ru">â€”</span></div>
        </div>
        <div style="margin-top:10px;">
          <b style="color:#ffe9b5;">Messaggio:</b>
          <div id="msg" style="margin-top:6px;line-height:1.5;color:#e9ecff;">â€”</div>
        </div>

        <div style="margin-top:12px;color:#9fb0ff;font-size:.95rem;">
          <b>Debug tag:</b> <span id="tagdbg">â€”</span>
        </div>
      </div>

      <p style="margin:14px 0 0;text-align:center;color:#9fb0ff;font-size:.95rem;">
        NFC via browser: <b>Android + Chrome/Edge</b>. Su PC vedrai sempre â€œNFC non supportatoâ€.
      </p>
    </div>
  </div>

<script>
(() => {
  // âœ… La tua Cloud Run
  const API_URL = "https://oracolo-nibi-web-207246221438.europe-west1.run.app";

  const $ = (id) => document.getElementById(id);

  const statusEl = $("status");
  const btnStart = $("btnStartNFC");
  const btnTest  = $("btnTestPC");
  const btnSpeak = $("btnSpeak");
  const btnStop  = $("btnStop");

  const elEl = $("el");
  const ruEl = $("ru");
  const msgEl = $("msg");
  const tagDbg = $("tagdbg");

  let lastTextToSpeak = "";
  let ndefReader = null;

  function setStatus(t) { statusEl.textContent = "Stato: " + t; }

  function enable(btn, on) {
    btn.disabled = !on;
    btn.style.opacity = on ? "1" : ".55";
  }

  function stopSpeaking() {
    try { window.speechSynthesis.cancel(); } catch(e) {}
  }

  function speak(text) {
    stopSpeaking();
    if (!text) return;

    if (!("speechSynthesis" in window)) {
      setStatus("TTS non supportato su questo browser.");
      return;
    }
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "it-IT";
    u.rate = 1.0;
    u.pitch = 1.0;
    window.speechSynthesis.speak(u);
  }

  function normalizeData(data) {
    const element = data.element ?? data.elemento ?? data.Elemento ?? "â€”";
    const rune    = data.rune ?? data.runa ?? data.Runa ?? "â€”";
    const message = data.message ?? data.messaggio ?? data.Messaggio ?? "â€”";
    return { element, rune, message };
  }

  function renderResult(element, rune, message, dbg) {
    elEl.textContent = element;
    ruEl.textContent = rune;
    msgEl.textContent = message;
    tagDbg.textContent = dbg || "â€”";

    lastTextToSpeak = `Elemento ${element}. Runa ${rune}. Messaggio: ${message}`;
    enable(btnSpeak, true);
    enable(btnStop, true);
  }

  async function fetchJsonOrText(url) {
    const r = await fetch(url, { method: "GET" });
    if (!r.ok) throw new Error("HTTP " + r.status);

    const ct = (r.headers.get("content-type") || "").toLowerCase();
    if (ct.includes("application/json")) return await r.json();

    const txt = await r.text();
    try { return JSON.parse(txt); }
    catch { return { message: txt }; }
  }

  async function callNibiWith(tagId, extraText) {
    const dbg = `tagId=${tagId}${extraText ? " | payload=" + extraText : ""}`;

    setStatus("Chiamo NIBIâ€¦");

    // Provo varianti comuni (cosÃ¬ non ti obbligo a cambiare Cloud Run)
    const qs = [
      ["tag", tagId],
      ["nfc", tagId],
      ["id",  tagId],
      ["uid", tagId]
    ];

    // Se dal tag leggo anche un testo/URL, lo mando come "payload"
    const payload = extraText ? encodeURIComponent(extraText) : "";

    let lastErr = null;

    for (const [k,v] of qs) {
      const base = API_URL.replace(/\/+$/,"");
      const urls = [
        `${base}?${k}=${encodeURIComponent(v)}&t=${Date.now()}${payload ? `&payload=${payload}` : ""}`,
        `${base}/?${k}=${encodeURIComponent(v)}&t=${Date.now()}${payload ? `&payload=${payload}` : ""}`
      ];

      for (const url of urls) {
        try {
          const data = await fetchJsonOrText(url);
          const { element, rune, message } = normalizeData(data);
          renderResult(element, rune, message, dbg);
          setStatus("Messaggio ricevuto âœ…");
          speak(lastTextToSpeak);
          return;
        } catch(e) { lastErr = e; }
      }
    }

    console.error(lastErr);
    setStatus("Errore: Cloud Run non risponde come atteso (o CORS).");
    tagDbg.textContent = dbg;
  }

  function extractTextRecords(message) {
    // Estrae eventuali record testo (se il tag ha NDEF scritto)
    const out = [];
    try {
      if (!message || !message.records) return out;
      for (const rec of message.records) {
        // record text
        if (rec.recordType === "text" && rec.data) {
          out.push(rec.data);
        }
        // url
        if (rec.recordType === "url" && rec.data) {
          out.push(rec.data);
        }
      }
    } catch(e) {}
    return out.filter(Boolean).map(x => String(x));
  }

  async function startNFC() {
    stopSpeaking();

    if (!("NDEFReader" in window)) {
      setStatus("NFC non supportato qui. Usa Android + Chrome/Edge.");
      return;
    }

    try {
      ndefReader = new NDEFReader();
      await ndefReader.scan();
      setStatus("NFC attivo. Ora tocca il tagâ€¦ âœ¨");
      enable(btnStop, true);

      ndefReader.onreading = async (event) => {
        const serial = event.serialNumber || "unknown-tag";
        // Se c'Ã¨ NDEF, provo a prendere anche il contenuto
        const texts = extractTextRecords(event.message);
        const payload = texts.length ? texts.join(" | ") : "";
        await callNibiWith(serial, payload);
      };

      ndefReader.onreadingerror = () => {
        setStatus("Non riesco a leggere il tag. Riprova avvicinando il telefono.");
      };

    } catch (e) {
      console.error(e);
      setStatus("NFC non attivato. Serve HTTPS + permesso browser (Android/Chrome).");
    }
  }

  // Test PC: chiama Nibi con un tag finto (cosÃ¬ verifichi API e voce)
  async function testPC() {
    const fake = "PC-TEST-" + Math.floor(Math.random()*999999);
    await callNibiWith(fake, "manual-test");
  }

  btnStart.addEventListener("click", startNFC);
  btnTest.addEventListener("click", testPC);
  btnSpeak.addEventListener("click", () => speak(lastTextToSpeak));
  btnStop.addEventListener("click", () => { stopSpeaking(); setStatus("Fermato."); });

  setStatus("pronto. Premi â€œAttiva NFCâ€ (telefono) o â€œTESTA (PC)â€.");
})();
</script>

</body>
</html>
